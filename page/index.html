<html>
<header >
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
    <title>聊天室</title>

    <script src="./amazeui/js/amazeui.js"></script>
    <link rel="stylesheet" href="./amazeui/css/amazeui.css"/>
    <link rel="stylesheet" href="./amazeui/css/amazeui.min.css"/>
    <link rel="stylesheet" href="./amazeui/css/index.css"/>
    <script src="../node_modules/jquery/dist/jquery.js"></script>

</header>
<body>
    <div class="chattop">
        <span class="am-icon-cog am-animation-spin"></span>
        <sprn>非常正经的聊天室</sprn>
        <span class="am-icon-cog am-animation-spin"></span>
    </div>
    <div class="persons">
        <img id="my-popover" src="./amazeui/img/pig.jpeg" alt="苏雨"
             class="am-img-thumbnail am-circle" width="50px" height="50px">
        <img src="./amazeui/img/dog.jpeg" alt="苏雨"
             class="am-img-thumbnail am-circle" width="50px" height="50px">
        <img src="./amazeui/img/cat.jpeg" alt="苏雨"
             class="am-img-thumbnail am-circle" width="50px" height="50px">
        <img src="./amazeui/img/wu.jpg" alt="苏雨"
             class="am-img-thumbnail am-circle" width="50px" height="50px"> &nbsp;&nbsp;...
        <input id ="img" type="hidden"/>
        <input id ="imgindex" type="hidden"/>
        <input id ="username" type="hidden" value="520"/>
    </div>
    <div class="chatcontent">
        <!-- 这里是聊天记录的显示-->
    </div>
    <div class="input-area">
        <input id="msg" type="email" class="eidtmsg" id="doc-ipt-email-1" placeholder="输入要发送信息">
        <button type="button" class="am-btn am-btn-success am-round send" onclick="send()">发送</button>
    </div>

</body>
<script>

    var username = Math.floor(Math.random()*(100000));
    $('#username').val(username)
    console.log(username)

    var user = {
        username: '',
        msg: '',
        img: '',
        imgindex: ''
    }
    // 打开一个 web socket
    var ws = new WebSocket("ws://localhost:8080/");
    if ("WebSocket" in window) {
        user.username = username
        //连接服务端
        ws.onopen = function() {
            ws.send(JSON.stringify(user));

        };

        ws.onmessage = function (evt)
        {
            var obj = JSON.parse(evt.data);
            console.log(obj)
            var username = $('#username').val()

            if (obj.username == username && obj.msg == undefined) {

                //收到用户信息放到隐藏域中
                $('#img').val(obj.img)
                $('#imgindex').val(obj.imgindex)

                console.log("单纯的连接")
            } else {
                //收到他人发送的信息
                if (obj.username != username && obj.msg != undefined) {
                    addMsg(obj.img,obj.msg,false)
                }
            }
        };

        ws.onclose = function()
        {
            // 关闭 websocket
            // alert("连接已关闭...");
        };
    }

        function addMsg(img,msg,bool) {
            //自己发信息要添加的html(bool 为true)
            var html =
                '<div class="sendbody">'+
                '<div style="display: inline;float: right">'+
                '<img src="'+img+'" alt="苏雨"class="am-img-thumbnail am-circle" width="40px" height="40px">'+
                '</div>'+
                '<div  class="msgsend" style="text-align: right">'
                + msg +
                '</div>'+
                '</div>';

            //收到他人信息时 要添加的html(bool为false)
            var friendmsg =
                '<div class="receivebody">'+
                '<div style="display: inline;">'+
                '<img src="'+img+'" alt="苏雨"class="am-img-thumbnail am-circle" width="40px" height="40px">'+
                '</div>'+
                '<div  class="msgreceive triangle-left">'
                + msg +
                '</div>'+
                '</div>';

            if (!bool) {
                html = friendmsg;
            }

            $(".chatcontent").append(html)

        }

    /**
     * 发送信息给服务器做转接
     */
    function send() {
            var msg = $('#msg').val();
            var img = $('#img').val();
            var imgindex = $('#imgindex').val();
            var username = $('#username').val();

            user.username = username;
            user.msg = msg;
            user.img = img;
            user.imgindex = imgindex

            ws.send(JSON.stringify(user));

            //将发送内容加到聊天记录框中
            addMsg(img,msg,true)
        }
</script>
</html>
