<html>
<header >
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
    <title>聊天室</title>

    <script src="./amazeui/js/amazeui.js"></script>
    <link rel="stylesheet" href="./amazeui/css/amazeui.css"/>
    <link rel="stylesheet" href="./amazeui/css/amazeui.min.css"/>
    <script src="../node_modules/jquery/dist/jquery.js"></script>

    <style>
        body {
            background: #f8f8f8;
            height: 100%;
        }
        .chattop {
            height: 30px;
            background: rgb(245, 214, 173);
            border-radius: 5px;
            text-align: center;
            color: white;
            font-size: 15px;
        }
        .persons {
            padding:10px 1%;
            height: 70px;
        }
        .chatcontent {
            margin:2% auto;
            width: 85%;
            height: 65%;
            padding-top:1%;
            /*position: relative;*/
            overflow-y:scroll;
            overflow-x:hidden;
            border: 1px solid #ccc;
            text-shadow: 1px 1px 1px #ddd;
            border-radius: 5px;
        }
        .receivebody {
            text-align:left;
            display: flex;
            margin-top: 5px;
        }
        .sendbody {
            text-align:right;
            margin-top: 5px;
        }
        .msgreceive {
            background-color: white;
            padding: 2px;
            border-radius: 10px;
            padding:0 10px ;
            height: 40px;
            line-height: 40px;
            max-width: 250px;

        }
        .msgsend {
            display: inline-block;
            background-color: rgb(245, 214, 173);
            padding: 2px;
            border-radius: 10px;
            padding:0 10px ;
            height: 40px;
            line-height: 40px;
            max-width: 250px;
        }
        .eidtmsg {
            height: 50px;
            margin-left: 2%;
            margin-top: 10px;
            padding: 5px !important;
            width: 78%;
        }
        .input-area{
            background: rgb(238, 237, 237);
            border-top:1px solid #ddd;
            position: absolute;
            width:100%;
            height:70px;
            bottom:0;
        }
        .input-area input{
            margin:1%;
            width:78%;
            border-radius:5px;
        }
        .send {
            width:15%;
            height:60%;
            margin-top:15px;
            margin-right:1%;
            float: right;
        }
    </style>

</header>
<body>
    <div class="chattop">
        <sprn>非常正经的聊天室</sprn>
    </div>
    <div class="persons">
        <img src="./amazeui/img/pig.jpeg" alt="苏雨"
             class="am-img-thumbnail am-circle" width="50px" height="50px">
        <img src="./amazeui/img/dog.jpeg" alt="苏雨"
             class="am-img-thumbnail am-circle" width="50px" height="50px">
        <img src="./amazeui/img/pig.jpeg" alt="苏雨"
             class="am-img-thumbnail am-circle" width="50px" height="50px">
        <img src="./amazeui/img/dog.jpeg" alt="苏雨"
             class="am-img-thumbnail am-circle" width="50px" height="50px"> &nbsp;&nbsp;...
        <input id ="img" type="hidden"/>
        <input id ="imgindex" type="hidden"/>
        <input id ="username" type="hidden" value="521"/>
    </div>
    <div class="chatcontent">
        <!-- 这里是聊天记录的显示-->
    </div>
    <div class="input-area">
        <input id="msg" type="email" class="eidtmsg" id="doc-ipt-email-1" placeholder="输入要发送信息">
        <button type="button" class="am-btn am-btn-success am-round send" onclick="send()">发送</button>
    </div>

</body>
<script>

    var user = {
        username: '520',
        msg: '',
        img: '',
        imgindex: ''
    }
    // 打开一个 web socket
    var ws = new WebSocket("ws://localhost:8080/");
    if ("WebSocket" in window) {
        //连接服务端
        ws.onopen = function() {
            ws.send(JSON.stringify(user));

        };

        ws.onmessage = function (evt)
        {
            var obj = JSON.parse(evt.data);
            var username = $('#username').val()

            if (obj.username == username && obj.msg == undefined) {

                //收到用户信息放到隐藏域中
                $('#img').val(obj.img)
                $('#imgindex').val(obj.imgindex)

                console.log("单纯的连接")
            } else {
                //收到他人发送的信息
                if (obj.username != '520' && obj.msg != undefined) {
                    addMsg(obj.img,obj.msg,false)
                }
            }
        };

        ws.onclose = function()
        {
            // 关闭 websocket
            // alert("连接已关闭...");
        };
    }

        function addMsg(img,msg,bool) {
            //自己发信息要添加的html(bool 为true)
            var html =
                '<div class="sendbody">'+
                '<div style="display: inline;float: right">'+
                '<img src="'+img+'" alt="苏雨"class="am-img-thumbnail am-circle" width="40px" height="40px">'+
                '</div>'+
                '<div  class="msgsend" style="text-align: right">'
                + msg +
                '</div>'+
                '</div>';

            //收到他人信息时 要添加的html(bool为false)
            var friendmsg =
                '<div class="receivebody">'+
                '<div style="display: inline;">'+
                '<img src="'+img+'" alt="苏雨"class="am-img-thumbnail am-circle" width="40px" height="40px">'+
                '</div>'+
                '<div  class="msgreceive triangle-left">'
                + msg +
                '</div>'+
                '</div>';

            if (!bool) {
                html = friendmsg;
            }

            $(".chatcontent").append(html)

        }

    /**
     * 发送信息给服务器做转接
     */
    function send() {
            var msg = $('#msg').val();
            var img = $('#img').val();
            var imgindex = $('#imgindex').val();
            var username = $('#username').val();

            user.username = username;
            user.msg = msg;
            user.img = img;
            user.imgindex = imgindex

            ws.send(JSON.stringify(user));

            //将发送内容加到聊天记录框中
            addMsg(img,msg,true)
        }
        // for (i=0;i< 6; i++) {
        //     if (i > 2) {
        //         addMsg('./amazeui/img/pig.jpeg','How are you ? ',false)
        //     } else {
        //         addMsg('./amazeui/img/dog.jpeg','I am fine And you ? ',true)
        //     }
        // }
</script>
</html>
